---
title: 可撤销并查集
date: 2019-11-14 14:23:51
categories:
- ACM
- 数据结构
tags:
- 并查集
---


# 可撤销并查集

如果并查集想要支持回退操作，那么必然不能进行路径压缩。

所以只能通过按秩（高度）合并的方法来保证复杂度。

每次将一个版本（原树的根和原树的秩以及一些其它需要维护的东西）放进栈中，回退的时候从栈中一个一个复原。

## 代码

```cpp
struct UFS {
  int par[maxn], h[maxn], top;
  struct Node {
    int x, y, fa, h;
    Node(int x = 0, int y = 0, int fa = 0, int h = 0)
        : x(x), y(y), fa(fa), h(h) {}
  } stk[maxn];

  void init(int n) {
    top = 0;
    for (int i = 1; i <= n; i++) par[i] = i, h[i] = 0;
  }
  int find(int x) { return x == par[x] ? x : find(par[x]); }
  void merge(int u, int v) {
    int x = find(u), y = find(v);
    // if (x == y) return; 和回退的次数相关
    if (h[x] > h[y]) swap(x, y);
    stk[top++] = Node(x, y, par[x], h[y]);
    if (h[x] == h[y]) h[y]++;
    par[x] = y;
  }
  void undo(int k) {
    for (int i = 0; i < k; i++) {
      Node &it = stk[--top];
      par[it.x] = it.fa;
      h[it.y] = it.h;
    }
  }
} ufs;
```